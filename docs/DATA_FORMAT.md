# データフォーマット仕様書

この文書では、古文単語学習アプリケーションで使用する語彙データのJSONL（JSON Lines）フォーマットについて詳しく説明します。

## 目次

- [概要](#概要)
- [ファイル構造](#ファイル構造)
- [データスキーマ](#データスキーマ)
- [フィールド詳細](#フィールド詳細)
- [例文フォーマット](#例文フォーマット)
- [データ作成ガイドライン](#データ作成ガイドライン)
- [検証とバリデーション](#検証とバリデーション)
- [サンプルデータ](#サンプルデータ)

## 概要

### JSONL（JSON Lines）とは

JSONL（JSON Lines）は、各行が独立したJSONオブジェクトで構成されるテキストファイル形式です。大量のデータを効率的に処理でき、ストリーミング処理に適しています。

### ファイル配置

語彙データファイルは以下の場所に配置してください：

- **メインファイル**: `public/kobun_q.jsonl`（優先読み込み）
- **フォールバック**: `public/kobun_words.jsonl`（メインファイルが無い場合）

## ファイル構造

```
public/
├── kobun_q.jsonl          # 問題形式データ（推奨）
└── kobun_words.jsonl      # 単語形式データ（フォールバック）
```

## データスキーマ

### 問題形式（kobun_q.jsonl）

```typescript
interface QuestionData {
  qid: string;              // 問題ID（例: "1-1"）
  lemma: string;            // 古語の語形
  group: number;            // 単語グループ番号
  sub: number;              // サブグループ番号
  word_idx: number;         // 単語インデックス
  meaning_idx: number;      // 意味インデックス
  sense: string;            // 語義（現代語訳）
  examples: Example[];      // 例文配列
}
```

### 例文形式

```typescript
interface Example {
  jp: string;               // 古典例文（日本語）
  translation?: string;     // 現代語訳
  source?: string;          // 出典情報
}
```

### 単語形式（kobun_words.jsonl）- フォールバック用

```typescript
interface WordData {
  lemma: string;            // 古語の語形
  meanings: Meaning[];      // 意味配列
}

interface Meaning {
  sense: string;            // 語義（現代語訳）
  aliases?: string[];       // 別名・同義語
  examples?: Example[];     // 例文配列
}
```

## フィールド詳細

### 必須フィールド

#### `qid` (string)
- 問題の一意識別子
- フォーマット: `"[word_idx]-[meaning_idx]"`
- 例: `"1-1"`, `"2-3"`, `"15-2"`

#### `lemma` (string)
- 古語の語形（見出し語）
- ひらがな・カタカナで記載
- 例: `"おどろく"`, `"ののしる"`, `"ねんず"`

#### `sense` (string)
- 語義（現代語での意味）
- 〔 〕で囲んで動詞の活用形を示すことが多い
- 例: `"〔 気づい 〕"`, `"〔 大騒ぎする 〕"`

#### `examples` (Example[])
- 例文の配列
- 最低1つの例文を含むことを推奨

### インデックスフィールド

#### `group` (number)
- 単語のグループ番号
- 関連する語義をまとめる際に使用

#### `sub` (number)
- サブグループ番号
- 同一語形の異なる意味を区別

#### `word_idx` (number)
- 単語の通し番号（1から開始）
- 学習範囲の指定に使用

#### `meaning_idx` (number)
- 意味の通し番号（全体での連番）
- 問題の並び順を決定

## 例文フォーマット

### 基本構造

```json
{
  "jp": "古典文の原文",
  "translation": "現代語訳",
  "source": "出典名"
}
```

### 記載ルール

#### 古典文（`jp`フィールド）
- 原文をそのまま記載
- 読点、句点は原則として使用しない
- 括弧内に出典を記載可能

例:
```
"秋来ぬと目にはさやかに見えねども風の音にぞおどろかれぬる（古今和歌集）"
```

#### 現代語訳（`translation`フィールド）
- 「（訳）」で開始
- 〔 〕内に対象語の現代語を明記
- 読みやすさを重視

例:
```
"（訳）秋がやって来たと、目にははっきり見えないけれど、風の音に（もう秋なのだと）自然と〔 気づい 〕たことだ。"
```

#### 出典（`source`フィールド）
- 作品名を記載
- 必要に応じて作者名も含む
- 一般的な略称を使用可能

例:
```
"源氏物語"
"古今和歌集"
"枕草子"
```

## データ作成ガイドライン

### 1. 単語選択

- 高校古典で頻出する語彙を選択
- 複数の意味を持つ語は全ての主要な意味を含める
- 現代日本語との意味の違いが明確な語を優先

### 2. 例文選択

- 文脈で意味が明確になる例文を選択
- 有名な作品からの引用を優先
- 1つの意味につき1-3個の例文を用意

### 3. 品質管理

- 古典文法の正確性を確認
- 現代語訳の適切性をチェック
- 出典情報の正確性を検証

### 4. データ整合性

- `qid`の重複が無いことを確認
- インデックス番号の連続性を保持
- 必須フィールドの欠損が無いことを確認

## 検証とバリデーション

### 基本検証

以下のスクリプトを使用してデータの整合性を確認できます：

```javascript
// JSONLファイルの基本検証
function validateJSONL(content) {
  const lines = content.trim().split('\n');
  const errors = [];

  lines.forEach((line, index) => {
    try {
      const data = JSON.parse(line);

      // 必須フィールドの確認
      if (!data.qid || !data.lemma || !data.sense) {
        errors.push(`Line ${index + 1}: Missing required fields`);
      }

      // 例文配列の確認
      if (!Array.isArray(data.examples)) {
        errors.push(`Line ${index + 1}: Examples must be an array`);
      }

    } catch (e) {
      errors.push(`Line ${index + 1}: Invalid JSON`);
    }
  });

  return errors;
}
```

### 詳細検証

- **ID重複チェック**: `qid`の重複がないことを確認
- **インデックス整合性**: `word_idx`, `meaning_idx`の連続性
- **例文完整性**: 各例文に`jp`フィールドがあることを確認
- **文字エンコーディング**: UTF-8エンコーディングの確認

## サンプルデータ

### 基本例

```jsonl
{"qid": "1-1", "lemma": "おどろく", "group": 1, "sub": 1, "word_idx": 1, "meaning_idx": 1, "sense": "〔 気づい 〕", "examples": [{"jp": "秋来ぬと目にはさやかに見えねども風の音にぞおどろかれぬる（古今和歌集）", "translation": "（訳）秋がやって来たと、目にははっきり見えないけれど、風の音に（もう秋なのだと）自然と〔 気づい 〕たことだ。"}]}
{"qid": "1-2", "lemma": "おどろく", "group": 1, "sub": 2, "word_idx": 1, "meaning_idx": 2, "sense": "〔 目を覚まし 〕", "examples": [{"jp": "物に襲はるる心地して、おどろき給へれば、灯も消えにけり。 （源氏物語）", "translation": "（訳）ものに襲われるような気持ちがして、〔 目を覚まし 〕なさると、灯も消えてしまっていた。"}]}
```

### 複数例文の例

```jsonl
{"qid": "4-1", "lemma": "おぼゆ", "group": 4, "sub": 1, "word_idx": 4, "meaning_idx": 7, "sense": "〔 思われ 〕", "examples": [{"jp": "いと悲しくおぼえけり。（大和物語）", "translation": "（訳）たいそう悲しく〔 思われ 〕た。"}, {"jp": "春はあけぼの、やうやう白くなりゆく山ぎはすこしあかりて（枕草子）", "translation": "（訳）春は明け方がよい。だんだん白くなっていく山際が少し明るくて"}]}
```

### 出典情報付きの例

```jsonl
{"qid": "2-1", "lemma": "ののしる", "group": 2, "sub": 1, "word_idx": 2, "meaning_idx": 3, "sense": "〔 大騒ぎする 〕", "examples": [{"jp": "とかくしつつののしるうちに、夜更けぬ。", "translation": "（訳）あれこれしながら〔 大騒ぎする 〕うちに、夜が更けた。", "source": "土佐日記"}]}
```

## データ更新とメンテナンス

### 更新手順

1. **バックアップ作成**: 現在のデータファイルのコピーを保存
2. **データ編集**: テキストエディタでJSONLファイルを編集
3. **検証実行**: バリデーションスクリプトで整合性確認
4. **アプリケーション確認**: ブラウザでの動作テスト
5. **本番反映**: 更新されたファイルを本番環境に配置

### バージョン管理

- データファイルの変更履歴を記録
- 重要な更新時はバージョン番号を付与
- 変更理由と影響範囲を文書化

この仕様に従ってデータを作成することで、アプリケーションが適切に動作し、学習者にとって有用な語彙学習体験を提供できます。